# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
CC         := gcc
AR         := ar
ARFLAGS    := rcs

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
CORE_DIR   := .
TEST_DIR   := tests
BUILD_DIR  := build
REPORT_DIR := report

# –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
LIB_NAME   := s21_matrix.a
TEST_BIN   := $(BUILD_DIR)/test_matrix
GCOV_EXEC  := $(BUILD_DIR)/test_matrix_gcov

# –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CFLAGS     := -std=c11 -Wall -Wextra -Werror -g

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
UNAME_S    := $(shell uname -s)

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ check
CHECK_CFLAGS := $(shell pkg-config --cflags check 2>/dev/null || echo "")
CHECK_LIBS   := $(shell pkg-config --libs check 2>/dev/null || echo "-lcheck")

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –ª–∏–Ω–∫–æ–≤–∫–∏
LDFLAGS := -lm -lpthread
ifeq ($(UNAME_S),Linux)
    LDFLAGS += -lsubunit
endif

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
CORE_SRC    := $(wildcard *.c)
TEST_SRC    := $(wildcard $(TEST_DIR)/*.c)

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
CORE_OBJ    := $(patsubst %.c,$(BUILD_DIR)/%.o,$(CORE_SRC))
TEST_OBJ    := $(patsubst $(TEST_DIR)/%.c,$(BUILD_DIR)/$(TEST_DIR)/%.o,$(TEST_SRC))
CORE_OBJ_GCOV := $(patsubst %.c,$(BUILD_DIR)/%_gcov.o,$(CORE_SRC))

# –¶–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
.PHONY: all lib test clean rebuild format check valgrind valgrind_verbose clean_gcov gcov_report

all: lib

# –°–±–æ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
lib: $(LIB_NAME)

$(LIB_NAME): $(CORE_OBJ)
	$(AR) $(ARFLAGS) $@ $^
	@echo "–°–æ–∑–¥–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ $@ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(BUILD_DIR)/%.o: %.c s21_matrix.h
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(CHECK_CFLAGS) -c $< -o $@

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
$(BUILD_DIR)/%_gcov.o: %.c s21_matrix.h
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(CHECK_CFLAGS) -fprofile-arcs -ftest-coverage -c $< -o $@

# –°–±–æ—Ä–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
$(TEST_BIN): $(TEST_OBJ) $(LIB_NAME)
	$(CC) $(CFLAGS) -o $@ $(TEST_OBJ) $(LIB_NAME) $(CHECK_LIBS) $(LDFLAGS)

# –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
$(GCOV_EXEC): $(TEST_OBJ) $(CORE_OBJ_GCOV)
	$(CC) $(CFLAGS) -fprofile-arcs -ftest-coverage -o $@ $(TEST_OBJ) $(CORE_OBJ_GCOV) $(CHECK_LIBS) $(LDFLAGS)

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
test: $(TEST_BIN)
	@./$(TEST_BIN)

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "–û—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞"
	@rm -rf $(BUILD_DIR) $(REPORT_DIR) $(LIB_NAME) *.gcno *.gcda *.gcov coverage*.info $(GCOV_EXEC)
	@echo "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

clean_gcov:
	@rm -f *.gcno *.gcda *.gcov gcov.* 2>/dev/null || true
	@rm -rf $(REPORT_DIR) 2>/dev/null || true

rebuild: clean all

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ (macOS –≤–µ—Ä—Å–∏—è)
valgrind: $(TEST_BIN)
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏..."
	@leaks -atExit -quiet -- ./$(TEST_BIN)
	

style:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –ø–æ —à–∫–æ–ª–µ 21"
	mv ../materials/linters/.clang-format .clang-format
	clang-format -n -style=Google *.c *.h $(TEST_DIR)/*.c $(TEST_DIR)/*.h
	mv .clang-format ../materials/linters/.clang-format
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

style_fix:
	@echo "üîç –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è –ø–æ —à–∫–æ–ª–µ 21"
	mv ../materials/linters/.clang-format .clang-format
	clang-format -i -style=Google *.c *.h $(TEST_DIR)/*.c $(TEST_DIR)/*.h
	mv .clang-format ../materials/linters/.clang-format
	@echo "üîç –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"



# –û—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
gcov_report: clean_gcov $(GCOV_EXEC)
	@echo "1. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º..."
	@./$(GCOV_EXEC)
	
	@echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–∫—Ä—ã—Ç–∏—è..."
	@if ls $(BUILD_DIR)/*.gcda 1>/dev/null 2>&1; then \
		echo "‚úì –§–∞–π–ª—ã –ø–æ–∫—Ä—ã—Ç–∏—è —Å–æ–∑–¥–∞–Ω—ã"; \
	else \
		echo "‚úó –§–∞–π–ª—ã –ø–æ–∫—Ä—ã—Ç–∏—è –ù–ï —Å–æ–∑–¥–∞–Ω—ã!"; \
		echo "   –í–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"; \
		exit 1; \
	fi
	
	@echo "3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞..."
	@mkdir -p $(REPORT_DIR)
	
	# –ò—Å–ø–æ–ª—å–∑—É–µ–º gcovr —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
	@gcovr --root . \
	       --exclude="tests/.*" \
	       --html --html-details \
	       -o $(REPORT_DIR)/index.html \
	       --gcov-ignore-errors=source_not_found \
	       2>/dev/null || \
	(gcovr --root . \
	       --exclude="tests/.*" \
	       --html --html-details \
	       -o $(REPORT_DIR)/index.html \
	       --gcov-ignore-errors=source_not_found; \
	 echo "‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $(REPORT_DIR)/index.html")
	
	@if [ -f "$(REPORT_DIR)/index.html" ]; then \
		echo "‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $(REPORT_DIR)/index.html"; \
		if command -v open >/dev/null 2>&1; then \
			open $(REPORT_DIR)/index.html 2>/dev/null || true; \
		elif command -v xdg-open >/dev/null 2>&1; then \
			xdg-open $(REPORT_DIR)/index.html 2>/dev/null || true; \
		fi; \
	else \
		echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç"; \
		echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å gcovr: pip install gcovr"; \
	fi